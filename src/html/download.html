<!DOCTYPE html>
<html lang="en">
<head>
	<title>Our Instagram</title>
	<meta charset="utf-8">
	<meta name="author" content="pixelhint.com">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />
	<link rel="stylesheet" type="text/css" href="css/reset.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript" src="js/date.js"></script>
</head>
<body>

	<header>
		<div class="logo">
			<a href="../wall"><img src="img/Instagram-Logo.png" title="OurInstagram" alt="OurInstagram"/></a>
		</div><!-- end logo -->

		<div id="menu_icon"></div>
		<nav>
			<ul>
				<li><a href="../wall">Стена</a></li>
				<li><a href="#" class="selected">Загрузить фотографию</a></li>
			</ul>
		</nav><!-- end navigation menu -->

		<div class="footer clearfix">
			<ul class="social clearfix">
				
				
				
			</ul><!-- end social -->

			<div class="rights">
				<p>Copyright © БПШ</p>
			</div><!-- end rights -->
		</div ><!-- end footer -->
	</header><!-- end header -->
		
		<section class="main clearfix">

		<section class="content">
			<h1>Загрузка фотографии</h1>
		<!--	<form action="#" method="post" enctype="multipart/form-data"> -->
					<div class="fileform">
						<div id="fileformlabel"></div>
						<div class="selectbutton">Обзор</div>
						<input type="file" accept="image/*" name="upload" id="upload" onchange="getName(this.value);" />
					</div>
	        		<br>
	        		<input type="text" name="author" placeholder="Автор" id="author" class="txtt"/>
	        		<textarea rows="4" cols="50" name="description" id="description" placeholder="Введите ваш комментарий к фотографии:" class="message" required></textarea>
	        		<div style="float:right;"><a style="text-decoration: none;" href="#" class="submit button">Загрузить фото</a></div>
				<!--	<input type="submit" class="button" name="submit" class="btn btn-default" value="Сохранить">
				</form>  -->
 					<br><br>
				<div class="ajax-respond"></div>
				<script>
				    var files;
 				    var d = new Date()).toString('dd.MM.yyyy');
 					var form = new FormData();

					$('input[type=file]').change(function(){
					    files = this.files;
						form.append("userName", document.getElementById('author').value);
						form.append("date", d);
						form.append("description", document.getElementById('description').value);
						form.append("photoFile", files[0]);
					});

					$('.submit.button').click(function( event ){
					    event.stopPropagation(); // Остановка происходящего
					    event.preventDefault();  // Полная остановка 
					    form.append("userName", document.getElementById('author').value);
						form.append("date", d);
						form.append("description", document.getElementById('description').value);
						form.append("photoFile", files[0]);
					    $.ajax({
					        url: './method/uploadPhoto',
					        type: 'POST',
					        data: form,
					        cache: false,
					        dataType: 'json',
					        processData: false, // Не обрабатываем файлы (Don't process the files)
					        contentType: false, // Так jQuery скажет серверу что это строковой запрос
					        success: function( respond, textStatus, jqXHR ){
					 
					            // Если все ОК
					 
					            if( typeof respond.error === 'undefined' ){
					                // Файлы успешно загружены, делаем что нибудь здесь
					 
					                // выведем пути к загруженным файлам в блок '.ajax-respond'
					 
					                var files_path = respond.files;
					                var html = '';
					                $.each( files_path, function( key, val ){ html += val +'<br>'; } )
					                $('.ajax-respond').html( html );
					            }
					            else{
					                console.log('ОШИБКИ ОТВЕТА сервера: ' + respond.error );
					            }
					        },
					        error: function( jqXHR, textStatus, errorThrown ){
					            console.log('ОШИБКИ AJAX запроса: ' + textStatus );
					        }
					    });
					 
					});
				</script>
		</section>  

	<script>function getName (str){
    if (str.lastIndexOf('\\')){
        var i = str.lastIndexOf('\\')+1;
    }
    else{
        var i = str.lastIndexOf('/')+1;
    }						
    var filename = str.slice(i);			
    var uploaded = document.getElementById("fileformlabel");
    uploaded.innerHTML = filename;
}</script>
</body>
</html>